<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Ecommerce Store</title>
    <link rel="stylesheet" href="../shared/navigation.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="menu-toggle"><i class="fas fa-bars"></i></button>
        </div>
        <div class="top-bar-center">
            <img class="store-logo" id="store-logo" alt="Store Logo">
            <div class="top-bar-title"></div>
        </div>
        <div class="top-bar-right">
            <button class="icon-btn search-btn"><i class="fas fa-search"></i></button>
            <button class="icon-btn cart-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cart-count">0</span>
            </button>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <nav class="sidebar-nav">
            <a href="../index.html" class="nav-item">Home</a>
            <a href="shopping-cart.html" class="nav-item">Cart</a>
            <a href="orders.html" class="nav-item active">My Orders</a>
            <a href="profile.html" class="nav-item" id="profile-nav" style="display:none;">Profile</a>
            <a href="../login.html" class="nav-item" id="login-nav">Login</a>
            <a href="#" class="nav-item" id="admin-nav" style="display:none;">Admin Panel</a>
            <a href="#" class="nav-item" id="logout-nav" style="display:none;">Logout</a>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <div class="main-content">
        <section class="orders-section">
            <h2 id="orders-title">My Orders</h2>
            <div id="orders-list">
                <!-- Orders will be loaded here -->
            </div>
        </section>
    </div>

    <script type="module" src="../shared/navigation.js"></script>
    <script>
        // Load orders
        async function loadOrders() {
            try {
                const { db, auth } = await import('./config/firebase-config.js');
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                console.log('=== DATABASE CHECK ===');
                console.log('Current user:', auth.currentUser.uid, auth.currentUser.email);
                
                // Check all orders in database
                const allOrdersQuery = query(collection(db, 'orders'));
                const allOrdersSnapshot = await getDocs(allOrdersQuery);
                console.log('Total orders in database:', allOrdersSnapshot.size);
                
                const allOrders = [];
                allOrdersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    allOrders.push({
                        id: doc.id,
                        userId: data.userId,
                        customerEmail: data.customerInfo?.email,
                        status: data.status,
                        total: data.total,
                        date: data.orderDate
                    });
                });
                
                console.log('All orders:', allOrders);
                
                const adminEmails = ['admin@cybee.com'];
                const isAdmin = adminEmails.includes(auth.currentUser.email.toLowerCase());
                console.log('Is admin:', isAdmin);
                
                let ordersQuery;
                if (isAdmin) {
                    ordersQuery = query(collection(db, 'orders'));
                } else {
                    ordersQuery = query(
                        collection(db, 'orders'),
                        where('userId', '==', auth.currentUser.uid)
                    );
                }
                
                const querySnapshot = await getDocs(ordersQuery);
                console.log('Filtered orders count:', querySnapshot.size);
                
                if (querySnapshot.empty) {
                    document.getElementById('orders-list').innerHTML = `
                        <p>No orders found for your account.</p>
                        <p><strong>Debug Info:</strong></p>
                        <p>Your User ID: ${auth.currentUser.uid}</p>
                        <p>Total orders in database: ${allOrdersSnapshot.size}</p>
                        <p>Orders matching your ID: ${allOrders.filter(o => o.userId === auth.currentUser.uid).length}</p>
                        <a href="../index.html">Start shopping</a>
                    `;
                    return;
                }
                
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Orders to display:', orders);
                
                if (isAdmin) {
                    document.getElementById('orders-title').textContent = 'All Orders (Admin View)';
                }
                
                displayOrders(orders, isAdmin);
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-list').innerHTML = '<p>Error loading orders. Please try again later.</p>';
            }
        }
        
        // Cancel order function
        window.cancelOrder = async function(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) {
                return;
            }
            
            try {
                const { db } = await import('./config/firebase-config.js');
                const { doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                // Get order data to restore stock
                const orderDoc = await getDoc(doc(db, 'orders', orderId));
                const orderData = orderDoc.data();
                
                // Restore stock for each item
                for (const item of orderData.items) {
                    if (!item.id) continue;
                    
                    try {
                        const productRef = doc(db, 'products', item.id);
                        const productDoc = await getDoc(productRef);
                        
                        if (productDoc.exists()) {
                            const currentStock = parseInt(productDoc.data().stock) || 0;
                            const restoreQuantity = parseInt(item.quantity) || 0;
                            const restoredStock = currentStock + restoreQuantity;
                            
                            await updateDoc(productRef, { stock: restoredStock });
                            console.log(`Stock restored for ${item.id}: ${currentStock} -> ${restoredStock}`);
                        }
                    } catch (error) {
                        console.error('Error restoring stock for product:', item.id, error);
                    }
                }
                
                // Update order status to cancelled
                await updateDoc(doc(db, 'orders', orderId), {
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString()
                });
                
                alert('Order cancelled successfully! Stock has been restored.');
                location.reload();
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Error cancelling order. Please try again.');
            }
        }
        
        // Display orders
        function displayOrders(orders, isAdmin = false) {
            const container = document.getElementById('orders-list');
            
            container.innerHTML = orders.map(order => `
                <div class="order-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 15px 0; background: white;">
                    <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0; color: #333;">Order #${order.orderNumber || order.id.substring(0, 8)}</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${new Date(order.orderDate).toLocaleDateString()}</p>
                            ${isAdmin ? `<p style="margin: 5px 0 0 0; color: #3498db; font-size: 14px; font-weight: bold;">Customer: ${order.customerInfo.name} (${order.customerInfo.email})</p>` : ''}
                        </div>
                        <div class="order-total" style="text-align: right;">
                            <p style="margin: 0; font-size: 18px; font-weight: bold; color: #27ae60;">â‚¹${order.total.toFixed(2)}</p>
                            <span style="background: ${order.status === 'cancelled' ? '#ffebee' : order.status === 'delivered' ? '#e8f5e8' : '#fff3e0'}; color: ${order.status === 'cancelled' ? '#c62828' : order.status === 'delivered' ? '#2e7d32' : '#ef6c00'}; padding: 4px 8px; border-radius: 12px; font-size: 12px; text-transform: capitalize;">${order.status || 'Pending'}</span>
                        </div>
                    </div>
                    
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                                <img src="${item.image || 'https://via.placeholder.com/60x60'}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; font-size: 16px;">${item.name}</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">Qty: ${item.quantity} Ã— â‚¹${item.price.toFixed(2)}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 0; font-weight: bold;">â‚¹${(item.price * item.quantity).toFixed(2)}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="order-address" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <p style="margin: 0; color: #666; font-size: 14px;"><strong>Delivery Address:</strong></p>
                        <p style="margin: 5px 0 10px 0; color: #333;">${order.customerInfo.address}</p>
                        ${(order.status === 'pending' || !order.status) ? `<button onclick="cancelOrder('${order.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel Order</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { auth } = await import('./config/firebase-config.js');
                const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        loadOrders();
                    } else {
                        document.getElementById('orders-list').innerHTML = '<p>Please login to view your orders. <a href="../login.html">Login</a></p>';
                    }
                });
            } catch (error) {
                console.error('Auth setup failed:', error);
                loadOrders();
            }
        });
    </script>
</body>
</html>