<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>Product Details - Ecommerce Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <button class="btn text-white me-2" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <a class="navbar-brand mx-auto" href="index.html">
                <span class="top-bar-title fw-bold"></span>
            </a>
            <button class="btn text-white position-relative cart-btn" onclick="window.location.href='shopping-cart.html'">
                <i class="fas fa-shopping-cart"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-count" style="display: none;">0</span>
            </button>
        </div>
    </nav>

    <div class="container-fluid p-2" style="margin-top: 60px;">
        <div class="row">
            <div class="col-lg-6">
                <div id="product-images" class="mb-2"></div>
            </div>
            <div class="col-lg-6">
                <div id="product-info" class="p-2"></div>
            </div>
        </div>
        
        <div class="container-fluid p-2">
            <h6 class="mb-2">Related Products</h6>
            <div class="row" id="related-products">
                <!-- Related products will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { doc, getDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        let currentProduct = null;
        let storeCurrency = '₹';

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            window.location.href = 'index.html';
        }

        // Load currency
        onSnapshot(doc(db, 'settings', 'pages'), (doc) => {
            if (doc.exists()) {
                storeCurrency = doc.data().currency || '₹';
                if (currentProduct) renderProduct();
            }
        });

        // Load product
        onSnapshot(doc(db, 'products', productId), (doc) => {
            if (doc.exists()) {
                currentProduct = { id: doc.id, ...doc.data() };
                renderProduct();
                loadRelatedProducts();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // Load related products
        function loadRelatedProducts() {
            onSnapshot(collection(db, 'products'), (querySnapshot) => {
                const allProducts = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== productId) {
                        allProducts.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                sessionStorage.setItem('allProducts', JSON.stringify(allProducts));
                const relatedProducts = allProducts.slice(0, 4);
                renderRelatedProducts(relatedProducts);
            });
        }
        
        function renderRelatedProducts(products) {
            const container = document.getElementById('related-products');
            if (!container) return;
            
            container.innerHTML = products.map(product => {
                const finalPrice = calculateFinalPrice(product.price, product.discount, product.discountType);
                const firstImage = product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/200x200';
                const isOutOfStock = (product.stock || 0) === 0;
                
                return `
                    <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-4">
                        <div class="card h-100 ${isOutOfStock ? 'opacity-75' : ''}" style="cursor: pointer;" onclick="window.location.href='product-details.html?id=${product.id}'">
                            ${product.discount ? `<div class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 rounded-end" style="z-index: 1;">${product.discount}${product.discountType === 'percentage' ? '%' : storeCurrency} OFF</div>` : ''}
                            <img src="${firstImage}" class="card-img-top" alt="${product.name}" style="height: 200px; object-fit: contain; background: white; padding: 15px 10px 10px 10px;">
                            <div class="card-body d-flex flex-column text-center p-2">
                                <div style="height: 2.5rem; display: flex; align-items: flex-start; justify-content: center; line-height: 1.1; font-size: 0.85rem; font-weight: 600;">${product.name}</div>
                                <div style="height: 1rem; display: flex; align-items: center; justify-content: center;">
                                    ${product.discount ? `<small class="text-muted text-decoration-line-through">${storeCurrency}${product.price}</small>` : ''}
                                </div>
                                <div style="height: 1.2rem; display: flex; align-items: center; justify-content: center;">
                                    <span class="text-primary fw-bold" style="font-size: 0.9rem;">${storeCurrency}${finalPrice.toFixed(2)}</span>
                                </div>
                                <div style="height: 1.2rem; display: flex; align-items: center; justify-content: center; margin-bottom: 0.3rem;">
                                    ${(product.stock || 0) === 0 ? '<span class="badge bg-danger">OUT OF STOCK</span>' : '<span class="badge bg-success">IN STOCK</span>'}
                                </div>
                                <div class="mt-auto">
                                    <button class="btn ${isOutOfStock ? 'btn-secondary' : 'btn-primary'} w-100 btn-sm" ${isOutOfStock ? 'disabled' : ''} onclick="event.stopPropagation(); addRelatedToCart('${product.id}')">
                                        ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.addRelatedToCart = async function(productId) {
            const allProducts = JSON.parse(sessionStorage.getItem('allProducts') || '[]');
            const product = allProducts.find(p => p.id === productId);
            if (product && (product.stock || 0) > 0) {
                const { addToCart } = await import('./cart.js');
                const finalPrice = calculateFinalPrice(product.price, product.discount, product.discountType);
                
                addToCart({
                    id: product.id,
                    name: product.name,
                    price: finalPrice,
                    originalPrice: product.price,
                    discount: product.discount || 0,
                    discountType: product.discountType,
                    unit: product.unit || 'pcs',
                    image: product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/300x200'
                });
                updateCartCount();
            }
        };

        function calculateFinalPrice(price, discount, discountType) {
            if (!discount) return price;
            if (discountType === 'percentage') {
                return price - (price * discount / 100);
            } else {
                return price - discount;
            }
        }

        function renderProduct() {
            if (!currentProduct) return;

            const finalPrice = calculateFinalPrice(currentProduct.price, currentProduct.discount, currentProduct.discountType);
            const isOutOfStock = (currentProduct.stock || 0) === 0;
            const images = currentProduct.images || ['https://via.placeholder.com/500x500'];

            document.getElementById('product-images').innerHTML = `
                <img src="${images[0]}" class="w-100" alt="${currentProduct.name}" style="height: 200px; object-fit: contain; background: white;">
            `;

            document.getElementById('product-info').innerHTML = `
                <h5 class="mb-2">${currentProduct.name}</h5>
                ${currentProduct.description ? `<p class="text-muted mb-2" style="font-size: 0.9rem;">${currentProduct.description}</p>` : ''}
                <div class="mb-2">
                    ${currentProduct.discount ? `<small class="text-muted text-decoration-line-through me-2">${storeCurrency}${currentProduct.price}</small>` : ''}
                    <span class="h6 text-primary">${storeCurrency}${finalPrice.toFixed(2)}</span>
                    ${currentProduct.discount ? `<span class="badge bg-danger ms-2">${currentProduct.discount}${currentProduct.discountType === 'percentage' ? '%' : storeCurrency} OFF</span>` : ''}
                </div>
                <div class="mb-2">
                    ${(currentProduct.stock || 0) === 0 ? '<span class="badge bg-danger">OUT OF STOCK</span>' : '<span class="badge bg-success">IN STOCK</span>'}
                    ${currentProduct.stock > 0 ? `<span class="text-muted ms-2" style="font-size: 0.8rem;">${currentProduct.stock} available</span>` : ''}
                </div>
                ${currentProduct.category ? `<div class="mb-2"><small class="text-muted">Category: ${currentProduct.category}</small></div>` : ''}
                ${currentProduct.unit ? `<div class="mb-2"><small class="text-muted">Unit: ${currentProduct.unit}</small></div>` : ''}
                ${currentProduct.vat ? `<div class="mb-2"><small class="text-muted">VAT: ${currentProduct.vat}%</small></div>` : ''}
                <button class="btn ${isOutOfStock ? 'btn-secondary' : 'btn-primary'} btn-sm w-100" ${isOutOfStock ? 'disabled' : ''} onclick="addToCart()">
                    ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                </button>
            `;

            // Update cart count
            updateCartCount();
        }

        window.addToCart = async function() {
            if (!currentProduct || (currentProduct.stock || 0) === 0) return;

            const { addToCart } = await import('./cart.js');
            const finalPrice = calculateFinalPrice(currentProduct.price, currentProduct.discount, currentProduct.discountType);
            const selectedUnit = document.getElementById('unit-select')?.value || currentProduct.unit || 'pcs';
            
            addToCart({
                id: currentProduct.id,
                name: currentProduct.name,
                price: finalPrice,
                originalPrice: currentProduct.price,
                discount: currentProduct.discount || 0,
                discountType: currentProduct.discountType,
                unit: selectedUnit,
                image: currentProduct.images && currentProduct.images.length > 0 ? currentProduct.images[0] : 'https://via.placeholder.com/300x200'
            });

            updateCartCount();
        };

        function updateCartCount() {
            const cartCountEl = document.querySelector('.cart-count');
            if (cartCountEl) {
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
                cartCountEl.textContent = totalItems;
                cartCountEl.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>