<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>Orders Management - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body class="admin-page">
    <!-- Top Bar -->
    <nav class="navbar navbar-dark bg-dark top-bar">
        <div class="container-fluid">
            <button class="btn text-white menu-toggle"><i class="fas fa-bars"></i></button>
            <div class="d-flex align-items-center">
                <img class="store-logo me-2" id="store-logo" alt="Store Logo" style="max-height: 40px; display: none;">
                <span class="navbar-brand mb-0 h1">Orders Management</span>
            </div>
            <div class="d-flex">
                <button class="btn text-white me-2" onclick="window.location.href='index.html'"><i class="fas fa-home"></i></button>
                <button class="btn text-white" id="admin-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar shadow-sm">
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item d-block p-3 border-bottom">Dashboard</a>
            <a href="orders.html" class="nav-item d-block p-3 border-bottom active">Orders</a>
            <a href="crm.html" class="nav-item d-block p-3 border-bottom">CRM</a>
            <a href="gallery.html" class="nav-item d-block p-3 border-bottom">Gallery</a>
            <a href="products.html" class="nav-item d-block p-3 border-bottom">Product Studio</a>
            <a href="product-settings.html" class="nav-item d-block p-3 border-bottom">Product Settings</a>
            <a href="page-settings.html" class="nav-item d-block p-3 border-bottom">Admin Settings</a>
            <a href="index.html" class="nav-item d-block p-3">View Store</a>
        </nav>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <div class="main-content bg-light">
        <div class="container-fluid h-100">
            <div class="row h-100">
                <!-- Left Side - Orders List -->
                <div class="col-md-4 bg-white border-end p-0">
                    <div class="p-3 border-bottom bg-light">
                        <h5 class="mb-1">Orders Management</h5>
                        <div class="small text-muted">
                            <span id="total-orders">Total: 0</span> | 
                            <span id="pending-orders">Pending: 0</span>
                        </div>
                    </div>
                    
                    <div class="p-3 border-bottom">
                        <input type="text" class="form-control" placeholder="Search orders..." id="order-search">
                    </div>
                    
                    <div class="overflow-auto" style="height: calc(100vh - 200px);" id="orders-list">
                        <!-- Orders loaded here -->
                    </div>
                </div>

                <!-- Right Side - Order Details -->
                <div class="col-md-8 d-flex flex-column">

                
                <div class="order-detail-view pt-3" id="order-detail-view" style="display: none; z-index: 10; position: relative; background: white;">
                    <div class="card-header d-flex justify-content-between align-items-center" style="display: none;" id="detail-header">
                        <h5 class="mb-0" id="order-title">Order Details</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="chatToCustomer()"><i class="fas fa-comment me-1"></i>Chat</button>
                            <select id="order-status-select" class="form-select form-select-sm" style="width: auto;" onchange="updateSelectedOrderStatus()">
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-danger btn-sm" onclick="deleteOrder(selectedOrder.id)"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="detail-content">
                        <div id="order-details-content">
                            <!-- Order details loaded here -->
                        </div>
                    </div>
                    
                    <!-- Mobile sticky bottom -->
                    <div class="card-footer d-md-none">
                        <div class="d-flex gap-2">
                            <select id="order-status-select-mobile" class="form-select" onchange="updateSelectedOrderStatusMobile()">
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <button class="btn btn-danger" onclick="deleteOrder(selectedOrder.id)"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Order Detail Modal -->
    <div id="mobile-order-modal" class="mobile-modal" style="display: none;">
        <div class="mobile-modal-header">
            <button class="mobile-back-btn" onclick="closeMobileModal()"><i class="fas fa-arrow-left"></i></button>
            <h3 id="mobile-order-title">Order Details</h3>
        </div>
        <div class="mobile-modal-content" id="mobile-order-content">
            <!-- Mobile order details loaded here -->
        </div>
        <div class="mobile-modal-footer p-3 border-top">
            <div class="d-flex gap-2 mb-2">
                <button class="btn btn-primary flex-fill" onclick="chatToCustomer()"><i class="fas fa-comment me-1"></i>Chat</button>
                <button class="btn btn-danger" onclick="deleteOrder(selectedOrder.id)"><i class="fas fa-trash"></i></button>
            </div>
            <select id="mobile-order-status" class="form-select" onchange="updateMobileOrderStatus()">
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
    </div>

    <script type="module" src="navigation.js"></script>
    <script type="module" src="auth-check.js"></script>
    <script>
        // Load orders from Firebase
        async function loadOrders() {
            try {
                const { db } = await import('./firebase-config.js');
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                console.log('Loading orders...');
                
                const querySnapshot = await getDocs(collection(db, 'orders'));
                console.log('Orders found:', querySnapshot.size);
                
                if (querySnapshot.empty) {
                    document.getElementById('orders-list').innerHTML = '<div class="chat-item"><div class="chat-info"><div class="chat-name">No orders found</div></div></div>';
                    return;
                }
                
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Displaying', orders.length, 'orders');
                
                window.allOrders = orders;
                displayOrders(orders);
                updateStats(orders);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('orders-list').innerHTML = `<div class="chat-item"><div class="chat-info"><div class="chat-name">Error: ${error.message}</div></div></div>`;
            }
        }
        
        let selectedOrder = null;
        
        // Display orders in messenger style
        function displayOrders(orders) {
            const container = document.getElementById('orders-list');
            
            container.innerHTML = orders.map(order => `
                <div class="chat-item" onclick="selectOrder('${order.id}')" data-order-id="${order.id}">
                    <div class="chat-avatar" style="background: ${getStatusColor(order.status)}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        #${order.id.substring(0, 2).toUpperCase()}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">Order #${order.orderNumber || order.id.substring(0, 8)}</div>
                        <div class="chat-preview">${order.customerInfo.name} - ₹${order.total.toFixed(2)}</div>
                    </div>
                    <div class="badge-container">
                        <div class="${getStatusBadgeClass(order.status)}">${(order.status || 'pending').toUpperCase()}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 2px;">${new Date(order.orderDate).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Get status color
        function getStatusColor(status) {
            switch(status) {
                case 'delivered': return '#2ecc71';
                case 'shipped': return '#3498db';
                case 'processing': return '#f39c12';
                case 'cancelled': return '#e74c3c';
                default: return '#9b59b6';
            }
        }
        
        // Get status badge class
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'pending-badge';
                case 'processing': return 'processing-badge';
                case 'shipped': return 'shipped-badge';
                case 'delivered': return 'delivered-badge';
                case 'cancelled': return 'cancelled-badge';
                default: return 'pending-badge';
            }
        }
        
        // Select order
        window.selectOrder = function(orderId) {
            // Remove active class from all items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            document.querySelector(`[data-order-id="${orderId}"]`).classList.add('active');
            
            // Find order data
            const order = window.allOrders.find(o => o.id === orderId);
            selectedOrder = order;
            
            // Mobile: Show modal
            if (window.innerWidth <= 768) {
                showMobileModal(order);
                return;
            }
            
            // Desktop: Show order details
            document.getElementById('order-detail-view').style.display = 'flex';
            
            // Show header
            document.getElementById('detail-header').style.display = 'flex';
            
            // Update order details
            document.getElementById('order-title').textContent = `Order #${order.orderNumber || order.id.substring(0, 8)}`;
            document.getElementById('order-status-select').value = order.status || 'pending';
            document.getElementById('order-status-select-mobile').value = order.status || 'pending';
            
            document.getElementById('order-details-content').innerHTML = `
                <div class="form-section">
                    <h3>Customer Information</h3>
                    <div class="info-row">
                        <label>Name:</label>
                        <span>${order.customerInfo.name}</span>
                    </div>
                    <div class="info-row">
                        <label>Email:</label>
                        <span>${order.customerInfo.email}</span>
                    </div>
                    <div class="info-row">
                        <label>Phone:</label>
                        <span>${order.customerInfo.phone}</span>
                    </div>
                    <div class="info-row">
                        <label>Address:</label>
                        <span>${order.customerInfo.address}</span>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Order Items</h3>
                    ${order.items.map(item => `
                        <div class="info-row">
                            <label>${item.name} x${item.quantity}:</label>
                            <span class="final-price">₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="info-row" style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
                        <label><strong>Total:</strong></label>
                        <span class="final-price"><strong>₹${order.total.toFixed(2)}</strong></span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Order Information</h3>
                    <div class="info-row">
                        <label>Order Date:</label>
                        <span>${new Date(order.orderDate).toLocaleString()}</span>
                    </div>
                    <div class="info-row">
                        <label>Status:</label>
                        <span>${(order.status || 'pending').toUpperCase()}</span>
                    </div>
                </div>
            `;
        }
        
        // Update selected order status (desktop)
        window.updateSelectedOrderStatus = async function() {
            const newStatus = document.getElementById('order-status-select').value;
            // Sync mobile select
            document.getElementById('order-status-select-mobile').value = newStatus;
            await updateOrderStatus(newStatus);
        }
        
        // Update selected order status (mobile)
        window.updateSelectedOrderStatusMobile = async function() {
            const newStatus = document.getElementById('order-status-select-mobile').value;
            // Sync desktop select
            document.getElementById('order-status-select').value = newStatus;
            await updateOrderStatus(newStatus);
        }
        
        // Common order status update function
        async function updateOrderStatus(newStatus) {
            if (!selectedOrder) return;
            
            try {
                const { db } = await import('./firebase-config.js');
                const { doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                const previousStatus = selectedOrder.status || 'pending';
                
                // If cancelling order or deleting, restore stock
                if ((newStatus === 'cancelled' && previousStatus !== 'cancelled') || newStatus === 'deleted') {
                    for (const item of selectedOrder.items) {
                        if (!item.id) continue;
                        
                        try {
                            const productRef = doc(db, 'products', item.id);
                            const productDoc = await getDoc(productRef);
                            
                            if (productDoc.exists()) {
                                const currentStock = parseInt(productDoc.data().stock) || 0;
                                const restoreQuantity = parseInt(item.quantity) || 0;
                                const restoredStock = currentStock + restoreQuantity;
                                
                                await updateDoc(productRef, { stock: restoredStock });
                                console.log(`Stock restored for ${item.id}: ${currentStock} -> ${restoredStock}`);
                            }
                        } catch (error) {
                            console.error('Error restoring stock for product:', item.id, error);
                        }
                    }
                }
                
                await updateDoc(doc(db, 'orders', selectedOrder.id), {
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                
                // Update local data
                selectedOrder.status = newStatus;
                
                showNotification('Order status updated successfully!', 'success');
                loadOrders(); // Reload to update list
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Error updating order status', 'error');
            }
        }
        
        // Update statistics
        function updateStats(orders) {
            const total = orders.length;
            const pending = orders.filter(o => o.status === 'pending' || !o.status).length;
            
            const totalEl = document.getElementById('total-orders');
            const pendingEl = document.getElementById('pending-orders');
            
            if (totalEl) totalEl.textContent = `Total: ${total}`;
            if (pendingEl) pendingEl.textContent = `Pending: ${pending}`;
        }
        
        // Logout function
        window.handleLogout = async function() {
            try {
                const { auth } = await import('./firebase-config.js');
                const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
                
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        

        
        // Show mobile modal
        function showMobileModal(order) {
            document.getElementById('mobile-order-title').textContent = `Order #${order.orderNumber || order.id.substring(0, 8)}`;
            document.getElementById('mobile-order-status').value = order.status || 'pending';
            
            document.getElementById('mobile-order-content').innerHTML = `
                <div class="form-section">
                    <h3>Customer Information</h3>
                    <div class="info-row">
                        <label>Name:</label>
                        <span>${order.customerInfo.name}</span>
                    </div>
                    <div class="info-row">
                        <label>Email:</label>
                        <span>${order.customerInfo.email}</span>
                    </div>
                    <div class="info-row">
                        <label>Phone:</label>
                        <span>${order.customerInfo.phone}</span>
                    </div>
                    <div class="info-row">
                        <label>Address:</label>
                        <span>${order.customerInfo.address}</span>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Order Items</h3>
                    ${order.items.map(item => `
                        <div class="info-row">
                            <label>${item.name} x${item.quantity}:</label>
                            <span class="final-price">₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="info-row" style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
                        <label><strong>Total:</strong></label>
                        <span class="final-price"><strong>₹${order.total.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Order Information</h3>
                    <div class="info-row">
                        <label>Order Date:</label>
                        <span>${new Date(order.orderDate).toLocaleString()}</span>
                    </div>
                    <div class="info-row">
                        <label>Status:</label>
                        <span>${(order.status || 'pending').toUpperCase()}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('mobile-order-modal').style.display = 'flex';
        }
        
        // Close mobile modal
        window.closeMobileModal = function() {
            document.getElementById('mobile-order-modal').style.display = 'none';
        }
        
        // Update mobile order status
        window.updateMobileOrderStatus = async function() {
            const newStatus = document.getElementById('mobile-order-status').value;
            await updateOrderStatus(newStatus);
        }
        
        // Delete order function
        window.deleteOrder = async function(orderId) {
            if (!confirm('Are you sure you want to delete this order? This will restore product stock.')) {
                return;
            }
            
            try {
                const { db } = await import('./firebase-config.js');
                const { doc, getDoc, updateDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                
                // Get order data to restore stock
                const orderDoc = await getDoc(doc(db, 'orders', orderId));
                const orderData = orderDoc.data();
                
                // Restore stock for each item
                for (const item of orderData.items) {
                    if (!item.id) continue;
                    
                    try {
                        const productRef = doc(db, 'products', item.id);
                        const productDoc = await getDoc(productRef);
                        
                        if (productDoc.exists()) {
                            const currentStock = parseInt(productDoc.data().stock) || 0;
                            const restoreQuantity = parseInt(item.quantity) || 0;
                            const restoredStock = currentStock + restoreQuantity;
                            
                            await updateDoc(productRef, { stock: restoredStock });
                            console.log(`Stock restored for ${item.id}: ${currentStock} -> ${restoredStock}`);
                        }
                    } catch (error) {
                        console.error('Error restoring stock for product:', item.id, error);
                    }
                }
                
                // Delete the order
                await deleteDoc(doc(db, 'orders', orderId));
                
                showNotification('Order deleted and stock restored successfully!', 'success');
                loadOrders(); // Reload orders list
                
                // Hide order detail view
                document.getElementById('order-detail-view').style.display = 'none';
                
            } catch (error) {
                console.error('Error deleting order:', error);
                showNotification('Error deleting order', 'error');
            }
        }
        
        // Chat to customer function
        window.chatToCustomer = function() {
            if (!selectedOrder) return;
            
            const customerEmail = selectedOrder.customerInfo.email;
            const subject = `Regarding Order #${selectedOrder.id.substring(0, 8)}`;
            const mailtoLink = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}`;
            
            window.open(mailtoLink, '_blank');
        }
        
        // Chat to customer function
        window.chatToCustomer = function() {
            if (!selectedOrder) return;
            
            const rawPhone = selectedOrder.customerInfo.phone.replace(/\D/g, '');
            const last10Digits = rawPhone.slice(-10);
            const formattedPhone = `+91${last10Digits}`;
            const message = `Hi! Regarding your Order #${selectedOrder.orderNumber || selectedOrder.id.substring(0, 8)}`;
            const whatsappLink = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappLink, '_blank');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { auth } = await import('./firebase-config.js');
                const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
                
                onAuthStateChanged(auth, (user) => {
                    if (user && user.email === 'admin@cybee.com') {
                        loadOrders();
                    } else {
                        alert('Access denied. Admin only.');
                        window.location.href = 'index.html';
                    }
                });
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
